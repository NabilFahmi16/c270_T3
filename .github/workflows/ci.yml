name: CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test-and-lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Lint with flake8
        run: |
          python -m flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || { echo "Lint errors found (strict mode)"; exit 1; }
          python -m flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Run pytest
        run: python -m pytest test_app.py -v

  docker-test:
    runs-on: ubuntu-latest
    needs: test-and-lint  # only run if unit/lint pass
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          docker build -t my-flask-app:test -f dockerfile .

      - name: Run container and test health
        run: |
          docker run -d -p 5000:5000 --name flask-test my-flask-app:test
          sleep 8
          curl --fail http://localhost:5000/health || { docker logs flask-test; exit 1; }
          docker stop flask-test && docker rm flask-test

  kubernetes-test:
    runs-on: ubuntu-latest
    needs: docker-test  # only if docker works
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up kind
        uses: helm/kind-action@v1
        with:
          version: v0.23.0
          config: |
            kind: Cluster
            apiVersion: kind.x-k8s.io/v1alpha4
            nodes:
              - role: control-plane

      - name: Build Docker image for KinD
        run: |
          docker build -t my-flask-app:test -f dockerfile .

      - name: Load image into KinD
        run: kind load docker-image my-flask-app:test

      - name: Deploy to KinD
        run: |
          cat <<EOF | kubectl apply -f -
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: flask-app
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: flask
            template:
              metadata:
                labels:
                  app: flask
              spec:
                containers:
                - name: flask
                  image: my-flask-app:test
                  imagePullPolicy: Never
                  ports:
                  - containerPort: 5000
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: flask-service
          spec:
            selector:
              app: flask
            ports:
            - protocol: TCP
              port: 80
              targetPort: 5000
            type: ClusterIP
          EOF

      - name: Wait for deployment ready
        run: kubectl wait --for=condition=Available deployment/flask-app --timeout=90s  # increased timeout a bit

      - name: Port-forward and test health endpoint
        run: |
          kubectl port-forward svc/flask-service 5000:80 &
          PF_PID=$!
          sleep 8  # give extra time for startup
          curl --fail http://localhost:5000/health || { kubectl get pods; kubectl logs -l app=flask --tail=50; exit 1; }
          kill $PF_PID || true

      - name: Active monitoring simulation (extra health check loop)
        run: |
          echo "Simulating basic active monitoring (3 checks)..."
          for i in {1..3}; do
            kubectl port-forward svc/flask-service 5000:80 >/dev/null 2>&1 &
            PF_PID=$!
            sleep 5
            curl --fail http://localhost:5000/health && echo "Check $i OK" || { echo "Check $i FAILED"; kill $PF_PID; exit 1; }
            kill $PF_PID
            sleep 3
          done

      - name: Debug K8s state (runs even on failure)
        if: always()
        run: |
          echo "=== Kubernetes Resources ==="
          kubectl get all
          echo "=== Deployment Description ==="
          kubectl describe deployment flask-app
          echo "=== Pod Description ==="
          kubectl describe pod -l app=flask
          echo "=== Pod Logs ==="
          kubectl logs -l app=flask --tail=100 || echo "No logs available"
