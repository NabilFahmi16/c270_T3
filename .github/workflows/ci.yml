name: CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test-and-lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Lint with flake8
        run: |
          # Strict mode - fail on selected errors
          python -m flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || { echo "Lint errors found (strict mode)"; exit 1; }
          # Full report (warnings allowed)
          python -m flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Run pytest
        run: python -m pytest test_app.py -v

  docker-test:
    runs-on: ubuntu-latest
    needs: test-and-lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: docker build -t my-flask-app:test -f dockerfile .

      - name: Run container and test health
        run: |
          docker run -d -p 5000:5000 --name flask-test my-flask-app:test
          sleep 10
          curl --fail --retry 3 --retry-delay 3 http://localhost:5000/health || {
            echo "Health check failed - showing container logs:"
            docker logs flask-test
            exit 1
          }
          docker stop flask-test && docker rm flask-test

  kubernetes-test:
    runs-on: ubuntu-latest
    needs: docker-test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ─── Python + test dependencies for rendering tests ───
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-k8s-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-k8s-

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # Install Playwright if your test_rendering.py uses it
          pip install pytest-playwright playwright
          # Install browsers (chromium is usually enough)
          python -m playwright install --with-deps chromium

      # ─── Kind / Kubernetes setup ───
      - name: Set up kind
        uses: helm/kind-action@v1
        id: kind
        with:
          version: v0.23.0
          cluster_name: kind-ci
          config: kind-config.yaml
          wait: 120s

      - name: Verify kind cluster
        run: |
          kind get clusters
          kubectl cluster-info --context kind-kind-ci || { echo "Cluster context broken"; exit 1; }
          kubectl get nodes

      - name: Build Docker image for KinD
        run: docker build -t my-flask-app:test -f dockerfile .

      - name: Load image into KinD
        run: kind load docker-image my-flask-app:test --name kind-ci

      - name: Deploy to KinD
        run: |
          cat <<EOF | kubectl apply -f -
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: flask-app
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: flask
            template:
              metadata:
                labels:
                  app: flask
              spec:
                containers:
                - name: flask
                  image: my-flask-app:test
                  imagePullPolicy: Never
                  ports:
                  - containerPort: 5000
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: flask-service
          spec:
            selector:
              app: flask
            ports:
            - protocol: TCP
              port: 80
              targetPort: 5000
            type: ClusterIP
          EOF

      - name: Wait for deployment ready
        run: kubectl wait --for=condition=Available deployment/flask-app --timeout=120s

      - name: Port-forward and test health endpoint
        run: |
          kubectl port-forward svc/flask-service 5000:80 >/dev/null 2>&1 &
          PF_PID=$!
          sleep 10
          curl --fail --retry 3 --retry-delay 3 http://localhost:5000/health || {
            echo "Health check failed - debug info:"
            kubectl get pods
            kubectl describe pod -l app=flask
            kubectl logs -l app=flask --tail=100
            kill $PF_PID || true
            exit 1
          }
          kill $PF_PID || true

      - name: Run browser-based rendering tests
        run: |
          kubectl port-forward svc/flask-service 5000:80 >/dev/null 2>&1 &
          PF_PID=$!
          sleep 15
          pytest tests/test_rendering.py -v || {
            echo "Rendering / UI test failed"
            kill $PF_PID || true
            exit 1
          }
          kill $PF_PID || true

      - name: Simulate active monitoring (3 health checks)
        run: |
          echo "Running 3 health checks..."
          for i in {1..3}; do
            kubectl port-forward svc/flask-service 5000:80 >/dev/null 2>&1 &
            PF_PID=$!
            sleep 6
            curl --fail http://localhost:5000/health && echo "Check $i OK" || {
              echo "Check $i FAILED"
              kill $PF_PID || true
              exit 1
            }
            kill $PF_PID || true
            sleep 4
          done

      # ─── Debug steps (always run) ───
      - name: Debug Kubernetes state (always)
        if: always()
        run: |
          echo "=== Kubernetes Resources ==="
          kubectl get all || true
          echo "=== Deployment Description ==="
          kubectl describe deployment flask-app || true
          echo "=== Pod Description ==="
          kubectl describe pod -l app=flask || true
          echo "=== Pod Logs ==="
          kubectl logs -l app=flask --tail=100 || echo "No logs available"
