name: CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test-and-lint:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Lint with flake8 (strict + report)
        run: |
          # Strict mode - fail on selected critical errors
          python -m flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # Full report (warnings noted but not failing)
          python -m flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Run pytest (all tests)
        run: |
          python -m pytest -v

  docker-test:
    runs-on: ubuntu-latest
    needs: test-and-lint
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: docker build -t my-flask-app:test -f dockerfile .

      - name: Run container and test health
        run: |
          set -e

          # Always cleanup container on exit
          cleanup() {
            docker logs flask-test || true
            docker rm -f flask-test || true
          }
          trap cleanup EXIT

          docker run -d -p 5000:5000 --name flask-test my-flask-app:test
          sleep 10

          curl --fail --retry 5 --retry-delay 3 http://localhost:5000/health

  kubernetes-test:
    runs-on: ubuntu-latest
    needs: docker-test
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up kind
        uses: helm/kind-action@v1
        with:
          version: v0.23.0
          cluster_name: kind-ci
          config: kind-config.yaml
          wait: 120s

      - name: Verify kind cluster
        run: |
          kind get clusters
          kubectl cluster-info --context kind-kind-ci
          kubectl get nodes

      - name: Build Docker image for KinD
        run: docker build -t my-flask-app:test -f dockerfile .

      - name: Load image into KinD
        run: kind load docker-image my-flask-app:test --name kind-ci

      - name: Deploy to KinD (prefer repo YAML if present)
        run: |
          set -e
          if [ -f deployment.yaml ] && [ -f service.yaml ]; then
            echo "Using deployment.yaml and service.yaml"
            kubectl apply -f deployment.yaml
            kubectl apply -f service.yaml
          else
            echo "deployment.yaml/service.yaml not found, using inline manifest"
            cat <<EOF | kubectl apply -f -
            apiVersion: apps/v1
            kind: Deployment
            metadata:
              name: flask-app
            spec:
              replicas: 1
              selector:
                matchLabels:
                  app: flask
              template:
                metadata:
                  labels:
                    app: flask
                spec:
                  containers:
                  - name: flask
                    image: my-flask-app:test
                    imagePullPolicy: Never
                    ports:
                    - containerPort: 5000
            ---
            apiVersion: v1
            kind: Service
            metadata:
              name: flask-service
            spec:
              selector:
                app: flask
              ports:
              - protocol: TCP
                port: 80
                targetPort: 5000
              type: ClusterIP
            EOF
          fi

      - name: Wait for deployment ready
        run: kubectl wait --for=condition=Available deployment/flask-app --timeout=180s

      - name: Port-forward and test health endpoint
        run: |
          set -e

          # Start port-forward
          kubectl port-forward svc/flask-service 5000:80 >/dev/null 2>&1 &
          PF_PID=$!

          # Always cleanup port-forward
          cleanup() { kill $PF_PID >/dev/null 2>&1 || true; }
          trap cleanup EXIT

          sleep 10
          curl --fail --retry 5 --retry-delay 3 http://localhost:5000/health

      - name: Simulate active monitoring (3 health checks)
        run: |
          set -e
          echo "Running 3 health checks..."
          for i in 1 2 3; do
            kubectl port-forward svc/flask-service 5000:80 >/dev/null 2>&1 &
            PF_PID=$!
            sleep 6

            curl --fail http://localhost:5000/health && echo "Check $i OK"

            kill $PF_PID >/dev/null 2>&1 || true
            sleep 3
          done

      - name: Debug Kubernetes state (always)
        if: always()
        run: |
          echo "=== Kubernetes Resources ==="
          kubectl get all || true
          echo "=== Deployment Description ==="
          kubectl describe deployment flask-app || true
          echo "=== Pod Description ==="
          kubectl describe pod -l app=flask || true
          echo "=== Pod Logs ==="
          kubectl logs -l app=flask --tail=100 || true
