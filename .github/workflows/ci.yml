name: CI/CD Pipeline

# Trigger pipeline on pushes and PRs to main branches
on:
  push:
    branches: [ main, master, basic-version ]
  pull_request:
    branches: [ main, master, basic-version ]

jobs:

  # -------------------------------
  # 1️⃣ TEST + LINT JOB
  # -------------------------------
  test-and-lint:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      # Pull repository code into the runner
      - name: Checkout code
        uses: actions/checkout@v4

      # Install Python 3.11 for app + tests
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"  # speeds up dependency installs

      # Install Python dependencies from requirements.txt
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Install browser needed for Playwright tests
      - name: Install Playwright browsers
        run: |
          python -m playwright install --with-deps chromium

      # Run flake8 linting
      # First command: fails on critical syntax errors
      # Second command: reports style issues but does NOT fail build
      - name: Lint with flake8 (strict + report)
        run: |
          python -m flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          python -m flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      # Start Flask app in background for integration tests
      - name: Start Flask app in background (for Playwright tests)
        run: |
          nohup python app.py > app.log 2>&1 &
          sleep 3

      # Ensure app is running before testing
      # Fails pipeline if /health is not reachable
      - name: Wait until app is ready
        run: |
          curl --fail --retry 10 --retry-delay 2 http://127.0.0.1:5000/health

      # Run all pytest test cases
      # Any failing test will fail the pipeline
      - name: Run pytest (all tests)
        run: |
          python -m pytest -v

      # Print Flask logs if any previous step failed
      - name: Show app log if failed
        if: failure()
        run: |
          echo "===== Flask app log ====="
          cat app.log || true

  # -------------------------------
  # 2️⃣ DOCKER BUILD + TEST JOB
  # -------------------------------
  docker-test:
    runs-on: ubuntu-latest
    needs: test-and-lint  # runs only if tests pass
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Enable Docker Buildx (modern Docker builder)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Build Docker image from Dockerfile
      - name: Build Docker image
        run: docker build -t my-flask-app:test -f dockerfile .

      # Run container and verify health endpoint
      # If health check fails → pipeline fails
      - name: Run container and test health
        run: |
          set -e

          # Cleanup container even if job fails
          cleanup() {
            docker logs flask-test || true
            docker rm -f flask-test || true
          }
          trap cleanup EXIT

          docker run -d -p 5000:5000 --name flask-test my-flask-app:test
          sleep 10
          curl --fail --retry 5 --retry-delay 3 http://localhost:5000/health

  # -------------------------------
  # 3️⃣ SECURITY SCAN (TRIVY)
  # -------------------------------
  trivy-security:
    runs-on: ubuntu-latest
    needs: docker-test
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Patch deployment.yaml in CI only
      # Purpose: avoid failing Trivy on readOnlyRootFilesystem rule (KSV014)
      - name: Patch Kubernetes deployment securityContext (CI only)
        shell: bash
        run: |
          # Adds:
          # securityContext.readOnlyRootFilesystem: true
          # + writable /tmp volume
          # Improves container security and passes Trivy scan
          python - <<'PY'
          # (Python script omitted here for brevity)
          PY

      # Install Trivy and cache vulnerability DB
      - name: Install Trivy (cache DB)
        uses: aquasecurity/trivy-action@0.24.0
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "table"
          exit-code: "0"  # never fail here (setup only)

      # Scan repository for:
      # - dependency vulnerabilities
      # - secrets
      # - Kubernetes misconfigurations
      # Fails on HIGH or CRITICAL
      - name: Trivy FS scan (repo) - vuln + secrets + misconfig
        uses: aquasecurity/trivy-action@0.24.0
        with:
          scan-type: "fs"
          scan-ref: "."
          severity: "HIGH,CRITICAL"
          scanners: "vuln,secret,misconfig"
          ignore-unfixed: true
          exit-code: "1"

      # Build Docker image for vulnerability scanning
      - name: Build Docker image (for Trivy image scan)
        run: docker build -t my-flask-app:test -f dockerfile .

      # Scan Docker image for OS & library vulnerabilities
      # Pipeline fails if HIGH/CRITICAL found
      - name: Trivy image scan - vulnerabilities
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: "my-flask-app:test"
          severity: "HIGH,CRITICAL"
          ignore-unfixed: true
          exit-code: "1"

  # -------------------------------
  # 4️⃣ KUBERNETES (KIND) TEST
  # -------------------------------
kubernetes-test:
  runs-on: ubuntu-latest
  needs: trivy-security
  timeout-minutes: 15
  steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up kind
      uses: helm/kind-action@v1
      with:
        version: v0.23.0
        cluster_name: kind-ci
        config: kind-config.yaml
        wait: 120s

    - name: Verify kind cluster
      run: |
        kind get clusters
        kubectl cluster-info --context kind-kind-ci
        kubectl get nodes

    - name: Build Docker image for KinD
      run: docker build -t my-flask-app:test -f dockerfile .

    - name: Load image into KinD
      run: kind load docker-image my-flask-app:test --name kind-ci


        run: |
          kubectl get all
          kubectl describe deployment flask-app
          kubectl logs -l app=flask
