name: CI/CD Pipeline

# Trigger pipeline on pushes and PRs to main branches
on:
  push:
    branches: [ main, master, basic-version ]
  pull_request:
    branches: [ main, master, basic-version ]

jobs:
  # -------------------------------
  # 1️⃣ TEST + LINT JOB
  # -------------------------------
  test-and-lint:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # ✅ Fix: Playwright must be installed before running "python -m playwright ..."
      - name: Install Playwright
        run: |
          pip install playwright

      - name: Install Playwright browsers
        run: |
          python -m playwright install --with-deps chromium

      - name: Lint with flake8 (strict + report)
        run: |
          python -m flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          python -m flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Start Flask app in background (for Playwright tests)
        run: |
          nohup python app.py > app.log 2>&1 &
          sleep 3

      - name: Wait until app is ready
        run: |
          curl --fail --retry 10 --retry-delay 2 http://127.0.0.1:5000/health

      - name: Run pytest (all tests)
        run: |
          python -m pytest -v

      - name: Show app log if failed
        if: failure()
        run: |
          echo "===== Flask app log ====="
          cat app.log || true

  # -------------------------------
  # 2️⃣ DOCKER BUILD + TEST JOB
  # -------------------------------
  docker-test:
    runs-on: ubuntu-latest
    needs: test-and-lint
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: docker build -t my-flask-app:test -f dockerfile .

      - name: Run container and test health
        run: |
          set -e

          cleanup() {
            docker logs flask-test || true
            docker rm -f flask-test || true
          }
          trap cleanup EXIT

          docker run -d -p 5000:5000 --name flask-test my-flask-app:test
          sleep 10
          curl --fail --retry 5 --retry-delay 3 http://localhost:5000/health

  # -------------------------------
  # 3️⃣ SECURITY SCAN (TRIVY)
  # -------------------------------
  trivy-security:
    runs-on: ubuntu-latest
    needs: docker-test
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # If you already fixed deployment.yaml in the repo,
      # you can REMOVE this patch step entirely.
      - name: Patch Kubernetes deployment securityContext (CI only)
        shell: bash
        run: |
          echo "Skipping patch step (deployment.yaml should already be fixed in repo)."

      - name: Install Trivy (cache DB)
        uses: aquasecurity/trivy-action@0.24.0
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "table"
          exit-code: "0"

      - name: Trivy FS scan (repo) - vuln + secrets + misconfig
        uses: aquasecurity/trivy-action@0.24.0
        with:
          scan-type: "fs"
          scan-ref: "."
          severity: "HIGH,CRITICAL"
          scanners: "vuln,secret,misconfig"
          ignore-unfixed: true
          exit-code: "1"

      - name: Build Docker image (for Trivy image scan)
        run: docker build -t my-flask-app:test -f dockerfile .

      - name: Trivy image scan - vulnerabilities
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: "my-flask-app:test"
          severity: "HIGH,CRITICAL"
          ignore-unfixed: true
          vuln-type: "os,library"
          format: "table"
          exit-code: "1"

  # -------------------------------
  # 4️⃣ KUBERNETES (KIND) TEST
  # -------------------------------
  kubernetes-test:
    runs-on: ubuntu-latest
    needs: trivy-security
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up kind
        uses: helm/kind-action@v1
        with:
          version: v0.23.0
          cluster_name: kind-ci
          config: kind-config.yaml
          wait: 120s

      - name: Verify kind cluster
        run: |
          kind get clusters
          kubectl cluster-info --context kind-kind-ci
          kubectl get nodes

      - name: Build Docker image for KinD
        run: docker build -t my-flask-app:test -f dockerfile .

      - name: Load image into KinD
        run: kind load docker-image my-flask-app:test --name kind-ci

      - name: Deploy to KinD
        run: |
          set -e
          kubectl apply -f deployment.yaml
          kubectl apply -f service.yaml

      - name: Wait for deployment ready
        run: kubectl wait --for=condition=Available deployment/flask-app --timeout=180s

      - name: Port-forward and test health endpoint
        run: |
          set -e

          kubectl port-forward svc/flask-service 5000:80 >/dev/null 2>&1 &
          PF_PID=$!

          cleanup() { kill $PF_PID >/dev/null 2>&1 || true; }
          trap cleanup EXIT

          sleep 8
          curl --fail --retry 5 --retry-delay 3 http://localhost:5000/health

      - name: Debug Kubernetes state (always)
        if: always()
        run: |
          echo "=== Kubernetes Resources ==="
          kubectl get all || true
          echo "=== Deployment Description ==="
          kubectl describe deployment flask-app || true
          echo "=== Pod Description ==="
          kubectl describe pod -l app=flask || true
          echo "=== Pod Logs ==="
          kubectl logs -l app=flask --tail=100 || true
